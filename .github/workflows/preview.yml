name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: cd frontend && npm run build
        env:
          STRAPI_API_URL: https://journal.hillpeople.net

      - name: Generate preview wrangler config
        run: |
          cat > frontend/wrangler-preview.json << EOF
          {
            "name": "hillpeople-preview-pr-${{ github.event.pull_request.number }}",
            "main": "./dist/_worker.js/index.js",
            "compatibility_date": "2025-04-15",
            "compatibility_flags": ["nodejs_compat"],
            "assets": {
              "binding": "ASSETS",
              "directory": "./dist"
            },
            "vars": {
              "STRAPI_API_URL": "https://journal.hillpeople.net"
            }
          }
          EOF

      - name: Deploy preview worker
        id: deploy
        shell: bash
        run: |
          set -o pipefail
          cd frontend && npx wrangler deploy --config wrangler-preview.json 2>&1 | tee deploy-output.txt
          PREVIEW_URL=$(grep -oP 'https://[^\s]+\.workers\.dev' deploy-output.txt | head -1)
          echo "url=$PREVIEW_URL" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_WORKERS_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Set preview secrets
        run: |
          printf '%s' "${{ secrets.STRAPI_API_TOKEN }}" | npx wrangler secret put STRAPI_API_TOKEN --name hillpeople-preview-pr-${{ github.event.pull_request.number }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_WORKERS_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.deploy.outputs.url }}';
            const body = `### Preview Deployment\n\nPreview: ${previewUrl}\n\nThis preview does not include Durable Object caching â€” requests go directly to Strapi. The worker is automatically deleted when this PR is closed.`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes('### Preview Deployment'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

  lighthouse:
    needs: deploy
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      statuses: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch latest post slugs
        id: slugs
        run: |
          RESPONSE=$(curl -s -g -H "Authorization: Bearer ${{ secrets.STRAPI_API_TOKEN }}" "https://journal.hillpeople.net/api/posts?pagination[pageSize]=3&sort=publishedDate:desc&fields[0]=slug")
          SLUG1=$(echo "$RESPONSE" | jq -r '.data[0].slug')
          SLUG2=$(echo "$RESPONSE" | jq -r '.data[1].slug')
          SLUG3=$(echo "$RESPONSE" | jq -r '.data[2].slug')
          echo "slug1=$SLUG1" >> $GITHUB_OUTPUT
          echo "slug2=$SLUG2" >> $GITHUB_OUTPUT
          echo "slug3=$SLUG3" >> $GITHUB_OUTPUT

      - name: Generate Lighthouse CI config
        run: |
          PREVIEW_URL="${{ needs.deploy.outputs.url }}"
          node -e "
            const baseConfig = require('./lighthouserc.js');
            const previewUrl = process.env.PREVIEW_URL;
            const urls = [
              previewUrl + '/',
              previewUrl + '/climbing',
              previewUrl + '/blog/${{ steps.slugs.outputs.slug1 }}',
              previewUrl + '/blog/${{ steps.slugs.outputs.slug2 }}',
              previewUrl + '/blog/${{ steps.slugs.outputs.slug3 }}'
            ];
            baseConfig.ci.collect.url = urls;
            baseConfig.ci.collect.numberOfRuns = 1;
            delete baseConfig.ci.collect.startServerCommand;
            delete baseConfig.ci.collect.startServerReadyPattern;
            console.log(JSON.stringify(baseConfig, null, 2));
          " > lighthouserc.json
        env:
          PREVIEW_URL: ${{ needs.deploy.outputs.url }}

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.14.x
          lhci autorun --config=lighthouserc.json
        env:
          LHCI_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LHCI_BUILD_CONTEXT__CURRENT_HASH: ${{ github.event.pull_request.head.sha }}

  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Delete preview worker
        run: |
          curl -s -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/workers/scripts/hillpeople-preview-pr-${{ github.event.pull_request.number }}" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_WORKERS_API_TOKEN }}" \
            -H "Content-Type: application/json"
