---
import { fetchClimbingTicksByDateRange, type ClimbingTick, type StrapiImage } from "../lib/api";
import PhotoGallery from "./PhotoGallery.astro";

interface Props {
    startDate: string;
    endDate?: string;
}

const { startDate, endDate } = Astro.props;

// If no endDate, use startDate for single-day trips
const effectiveEndDate = endDate || startDate;

const ticks = await fetchClimbingTicksByDateRange(startDate, effectiveEndDate);

// Group ticks by route (deduping multiple climbers)
interface TickDetail {
    climber?: string;
    style?: string;
    leadStyle?: string;
    pitches: number;
    notes?: string;
}

interface GroupedRoute {
    route: ClimbingTick['route'];
    ticks: TickDetail[];
    bestStars: number;
    photos: StrapiImage[];
}

function groupTicksByRoute(tickList: ClimbingTick[]): GroupedRoute[] {
    const routeMap = new Map<string, GroupedRoute>();

    for (const tick of tickList) {
        const groupKey = tick.route?.mountainProjectUrl || 'unknown';

        if (!routeMap.has(groupKey)) {
            routeMap.set(groupKey, {
                route: tick.route,
                ticks: [],
                bestStars: 0,
                photos: [],
            });
        }

        const groupedRoute = routeMap.get(groupKey)!;

        groupedRoute.ticks.push({
            climber: tick.person?.name,
            style: tick.style,
            leadStyle: tick.leadStyle,
            pitches: tick.pitches || 1,
            notes: tick.notes || undefined,
        });

        if (tick.yourStars && tick.yourStars > groupedRoute.bestStars) {
            groupedRoute.bestStars = tick.yourStars;
        }

        // Collect photos from all ticks for this route
        if (tick.photos?.length) {
            for (const photo of tick.photos) {
                if (!groupedRoute.photos.some(p => p.id === photo.id)) {
                    groupedRoute.photos.push(photo);
                }
            }
        }
    }

    return Array.from(routeMap.values());
}

function formatTickLabel(tick: TickDetail): string {
    const parts: string[] = [];
    if (tick.climber) parts.push(tick.climber);
    if (tick.style) {
        let styleStr = tick.style;
        if (tick.leadStyle) styleStr += ` · ${tick.leadStyle}`;
        parts.push(styleStr);
    }
    if (tick.pitches > 1) parts.push(`${tick.pitches}p`);
    return parts.join(" — ");
}

const routes = groupTicksByRoute(ticks);
---

{routes.length > 0 && (
    <div class="climbing-embed my-8 p-4 rounded-lg border border-[var(--color-accent)] bg-[var(--color-bg)]">
        <h3 class="text-lg font-semibold mb-3 text-[var(--color-header)]">
            Pitches Climbed
        </h3>
        <div class="space-y-2">
            {routes.map((groupedRoute) => {
                const uniqueNotes = groupedRoute.ticks
                    .map(t => t.notes)
                    .filter((n, i, arr): n is string => !!n && arr.indexOf(n) === i);
                return (
                <div class="flex items-start gap-4 p-2 rounded border border-[var(--color-accent)] hover:border-[var(--color-header)] transition">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-baseline gap-2 flex-wrap">
                            <a
                                href={groupedRoute.route?.mountainProjectUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="font-semibold hover:underline text-[var(--color-header)]"
                            >
                                {groupedRoute.route?.name || "Unknown Route"}
                            </a>
                            {groupedRoute.route?.rating && (
                                <span class="text-sm font-mono">{groupedRoute.route.rating}</span>
                            )}
                            {groupedRoute.route?.routeType && (
                                <span class="text-xs opacity-70">{groupedRoute.route.routeType}</span>
                            )}
                        </div>
                        {groupedRoute.route?.location && (
                            <p class="text-sm truncate">{groupedRoute.route.location}</p>
                        )}
                        <div class="mt-1 space-y-0.5">
                            {groupedRoute.ticks.map((tick) => (
                                <div class="text-xs opacity-70">{formatTickLabel(tick)}</div>
                            ))}
                        </div>
                        {uniqueNotes.length > 0 && (
                            <p class="text-sm mt-2 italic opacity-80">
                                {uniqueNotes.join(" · ")}
                            </p>
                        )}
                        <PhotoGallery
                            photos={groupedRoute.photos}
                            galleryId={`embed-${groupedRoute.route?.documentId || 'unknown'}`}
                        />
                    </div>
                    {groupedRoute.bestStars > 0 && (
                        <div class="flex-shrink-0 text-sm text-[var(--color-header)]" title={`${groupedRoute.bestStars} stars`}>
                            {"★".repeat(groupedRoute.bestStars)}{"☆".repeat(4 - groupedRoute.bestStars)}
                        </div>
                    )}
                </div>
                );
            })}
        </div>
    </div>
)}
