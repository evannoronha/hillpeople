---
interface DataPoint {
    label: string;
    value: number;
    color?: string;
}

interface Props {
    data: DataPoint[];
    title?: string;
    size?: number;
    strokeWidth?: number;
}

const { data, title, size = 200, strokeWidth = 40 } = Astro.props;

// Filter out zero values and calculate total
const filteredData = data.filter(d => d.value > 0);
const total = filteredData.reduce((sum, d) => sum + d.value, 0);

// Default colors if not provided
const defaultColors = [
    'var(--color-header)',      // Coral
    'var(--color-accent)',      // Teal
    '#d77a40',                  // Orange
    '#8a8a6c',                  // Olive
    '#b5855a',                  // Tan
    '#5e413b',                  // Brown
];

// Calculate SVG dimensions
const viewBoxSize = 100;
const center = viewBoxSize / 2;
const radius = (viewBoxSize - strokeWidth / 2) / 2 - 5;
const circumference = 2 * Math.PI * radius;

// Calculate segment positions
let currentOffset = 0;
const segments = filteredData.map((item, i) => {
    const percent = item.value / total;
    const segmentLength = circumference * percent;
    const segment = {
        ...item,
        color: item.color || defaultColors[i % defaultColors.length],
        offset: currentOffset,
        length: segmentLength,
        percent: Math.round(percent * 100),
    };
    currentOffset += segmentLength;
    return segment;
});
---

<div class="donut-container">
    {title && <h3 class="text-lg font-semibold mb-4 text-center">{title}</h3>}

    <div class="flex flex-col sm:flex-row items-center gap-6">
        <!-- SVG Donut -->
        <div class="relative" style={`width: ${size}px; height: ${size}px;`}>
            <svg
                viewBox={`0 0 ${viewBoxSize} ${viewBoxSize}`}
                class="donut-svg transform -rotate-90"
                style={`width: ${size}px; height: ${size}px;`}
            >
                {/* Background circle */}
                <circle
                    cx={center}
                    cy={center}
                    r={radius}
                    fill="none"
                    stroke="var(--color-accent)"
                    stroke-opacity="0.2"
                    stroke-width={strokeWidth / 5}
                />

                {/* Data segments */}
                {segments.map((segment, i) => (
                    <circle
                        cx={center}
                        cy={center}
                        r={radius}
                        fill="none"
                        stroke={segment.color}
                        stroke-width={strokeWidth / 5}
                        stroke-dasharray={`${segment.length} ${circumference - segment.length}`}
                        stroke-dashoffset={-segment.offset}
                        class="donut-segment"
                        data-index={i}
                        style={`--segment-index: ${i};`}
                    />
                ))}
            </svg>

            <!-- Center text -->
            <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span class="text-2xl font-bold">{total}</span>
                <span class="text-xs opacity-70">total</span>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend flex flex-col gap-2">
            {segments.map(segment => (
                <div class="flex items-center gap-2">
                    <span
                        class="w-3 h-3 rounded-full shrink-0"
                        style={`background-color: ${segment.color};`}
                    ></span>
                    <span class="text-sm">
                        {segment.label}
                        <span class="opacity-70 ml-1">({segment.value})</span>
                    </span>
                </div>
            ))}
        </div>
    </div>

    {filteredData.length === 0 && (
        <p class="text-center opacity-60 py-4">No data available</p>
    )}
</div>

<style>
    .donut-segment {
        transform-origin: center;
        animation: draw-segment 1s ease-out forwards;
        animation-delay: calc(var(--segment-index, 0) * 150ms);
        stroke-dasharray: 0 1000;
    }

    @keyframes draw-segment {
        to {
            stroke-dasharray: var(--final-dash);
        }
    }
</style>

<script>
    // Set final dasharray for animation
    document.querySelectorAll('.donut-segment').forEach(segment => {
        const dashArray = segment.getAttribute('stroke-dasharray');
        if (dashArray) {
            (segment as HTMLElement).style.setProperty('--final-dash', dashArray);
        }
    });
</script>
