---
import Layout from '../../layouts/Layout.astro';
import Prose from '../../components/Prose.astro';
import ResponsiveHeroImage from '../../components/ResponsiveHeroImage.astro';
import ArticleHeader from '../../components/ArticleHeader.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import StructuredData from '../../components/StructuredData.astro';
import StravaEmbed from '../../components/StravaEmbed.astro';
import ClimbingEmbed from '../../components/ClimbingEmbed.astro';
import { fetchPostBySlug, fetchSiteSettings } from '../../lib/api';
import {
  getMediaUrl,
  getLargestImage,
  transformContentUrls,
  injectHeadingIds,
} from '../../lib/imageUrl';
import { calculateReadingTime } from '../../lib/readingTime';

const { slug } = Astro.params;

// Extract query params for preview mode
const previewMode = Astro.url.searchParams.get('status') == 'draft';

const [post, siteSettings] = await Promise.all([
  fetchPostBySlug(slug!, previewMode),
  fetchSiteSettings(),
]);

if (!post) {
  return Astro.rewrite('/404');
}

// Transform content: fix URLs and inject heading IDs for TOC
let htmlContent = transformContentUrls(post.richContent);
htmlContent = injectHeadingIds(htmlContent);

// Image data
const coverImage = post.coverImage;
const largestImage = getLargestImage(post);
const imageUrl = getMediaUrl(largestImage?.url);

// Meta data
const seoTitle = post.seo?.metaTitle || post.title;
const seoDescription = post.seo?.metaDescription || post.seo?.excerpt || '';
const authorName =
  post.authorName ||
  `${post.createdBy?.firstname || ''} ${post.createdBy?.lastname || ''}`.trim();
const siteName = siteSettings?.siteName || 'Hill People';
const canonicalUrl = `https://hillpeople.net/blog/${slug}`;

// Reading time
const readingTime = calculateReadingTime(post.richContent || '');

// Breadcrumbs
const breadcrumbs = [{ name: 'Home', url: '/' }, { name: post.title }];

// Structured data
const structuredData = {
  type: 'BlogPosting' as const,
  title: seoTitle,
  description: seoDescription,
  datePublished: post.publishedDate,
  authorName,
  imageUrl,
  url: canonicalUrl,
  siteName,
};
---

<Layout
  pageTitle={seoTitle}
  description={seoDescription}
  ogImage={imageUrl}
  ogType="article"
  publishedTime={post.publishedDate}
  authorName={authorName}
  siteName={siteName}
>
  <StructuredData data={structuredData} />

  <article itemscope itemtype="https://schema.org/BlogPosting">
    {coverImage && (
      <ResponsiveHeroImage
        image={coverImage}
        alt={coverImage.alternativeText || post.title}
        priority={true}
      />
    )}

    <div class="max-w-3xl mx-auto px-4 py-8">
      <Breadcrumbs items={breadcrumbs} />

      <ArticleHeader
        title={post.title}
        authorName={authorName}
        publishedDate={post.publishedDate}
        readingTimeMinutes={readingTime}
      />

      <TableOfContents htmlContent={htmlContent} minHeadings={3} />

      <Prose set:html={htmlContent} />

      {post.stravaActivityId && (
        <div class="mt-10">
          <StravaEmbed activityId={post.stravaActivityId} />
        </div>
      )}

      {post.climbingDateRange?.showClimbingData &&
        post.climbingDateRange?.startDate && (
          <ClimbingEmbed
            startDate={post.climbingDateRange.startDate}
            endDate={post.climbingDateRange.endDate}
          />
        )}

      <ShareButtons url={canonicalUrl} title={post.title} />
    </div>
  </article>
</Layout>
