---
import Layout from '../../layouts/Layout.astro';
import Prose from '../../components/Prose.astro';
import ResponsiveHeroImage from '../../components/ResponsiveHeroImage.astro';
import ArticleHeader from '../../components/ArticleHeader.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import StructuredData from '../../components/StructuredData.astro';
import StravaEmbed from '../../components/StravaEmbed.astro';
import ClimbingEmbed from '../../components/ClimbingEmbed.astro';
import { fetchPostBySlug, fetchSiteSettings } from '../../lib/api';
import type { PhotoAlbum } from '../../lib/api';
import { galleryImageUrl } from '../../lib/gallery-images';
import {
  getMediaUrl,
  getLargestImage,
  transformContentUrls,
  injectHeadingIds,
} from '../../lib/imageUrl';
import { calculateReadingTime } from '../../lib/readingTime';

const { slug } = Astro.params;

// Extract query params for preview mode
const previewMode = Astro.url.searchParams.get('status') == 'draft';

// Set cache headers based on mode
if (previewMode) {
  Astro.response.headers.set('Cache-Control', 'private, no-store');
} else {
  // Cache for 1 hour, allow stale content while revalidating for up to 1 day
  Astro.response.headers.set('Cache-Control', 'public, s-maxage=3600, stale-while-revalidate=86400');
}

const [post, siteSettings] = await Promise.all([
  fetchPostBySlug(slug!, previewMode, Astro.locals),
  fetchSiteSettings(Astro.locals),
]);

if (!post) {
  return Astro.rewrite('/404');
}

// Transform content: fix URLs and inject heading IDs for TOC
let htmlContent = transformContentUrls(post.richContent);
htmlContent = injectHeadingIds(htmlContent);

// Image data
const coverImage = post.coverImage;
const largestImage = getLargestImage(post);
const imageUrl = getMediaUrl(largestImage?.url);

// Meta data
const seoTitle = post.seo?.metaTitle || post.title;
const seoDescription = post.seo?.metaDescription || post.seo?.excerpt || '';
const authorName =
  post.authorName ||
  `${post.createdBy?.firstname || ''} ${post.createdBy?.lastname || ''}`.trim();
const siteName = siteSettings?.siteName || 'Hill People';
const canonicalUrl = `https://hillpeople.net/blog/${slug}`;

// Reading time
const readingTime = calculateReadingTime(post.richContent || '');

// Breadcrumbs
const breadcrumbs = [{ name: 'Home', url: '/' }, { name: post.title }];

// Structured data
const structuredData = {
  type: 'BlogPosting' as const,
  title: seoTitle,
  description: seoDescription,
  datePublished: post.publishedDate,
  authorName,
  imageUrl,
  url: canonicalUrl,
  siteName,
};
---

<Layout
  pageTitle={seoTitle}
  description={seoDescription}
  ogImage={imageUrl}
  ogType="article"
  publishedTime={post.publishedDate}
  authorName={authorName}
  siteName={siteName}
>
  <StructuredData data={structuredData} />

  <article>
    {coverImage && (
      <ResponsiveHeroImage
        image={coverImage}
        alt={coverImage.alternativeText || post.title}
        priority={true}
      />
    )}

    <div class="max-w-3xl mx-auto px-4 py-8">
      <Breadcrumbs items={breadcrumbs} />

      <ArticleHeader
        title={post.title}
        authorName={authorName}
        publishedDate={post.publishedDate}
        readingTimeMinutes={readingTime}
      />

      <TableOfContents htmlContent={htmlContent} minHeadings={3} />

      <Prose set:html={htmlContent} />

      {post.stravaActivityId && (
        <div class="mt-10">
          <StravaEmbed activityId={post.stravaActivityId} />
        </div>
      )}

      {post.climbingDateRange?.showClimbingData &&
        post.climbingDateRange?.startDate && (
          <ClimbingEmbed
            startDate={post.climbingDateRange.startDate}
            endDate={post.climbingDateRange.endDate}
          />
        )}

      {/* Photo gallery links */}
      {post.photoAlbums && post.photoAlbums.length > 0 && (
        <div class="mt-10 pt-8 border-t border-[var(--color-accent)]/30">
          <h2 class="text-2xl font-bold mb-4">Photo Gallery</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {(post.photoAlbums as PhotoAlbum[]).map((album) => (
              <a
                href={`/photos/${album.slug}`}
                class="group flex gap-4 items-center p-3 rounded-lg border border-[var(--color-accent)]/20 hover:border-[var(--color-header)]/40 transition-colors"
              >
                {album.coverImagePath && (
                  <div class="w-20 h-20 rounded overflow-hidden flex-shrink-0">
                    <img
                      src={galleryImageUrl(album.coverImagePath, "thumbnail", { fit: "cover" })}
                      alt={album.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      loading="lazy"
                    />
                  </div>
                )}
                <div>
                  <span class="font-bold group-hover:text-[var(--color-header)] transition-colors">
                    {album.title}
                  </span>
                  <span class="block text-sm opacity-70 mt-1">
                    {album.photos?.length || 0} photos &rarr;
                  </span>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}

    </div>
  </article>
</Layout>
