---
import Layout from "../../layouts/Layout.astro";
import Prose from "../../components/Prose.astro";
import { fetchPostBySlug, fetchSiteSettings } from "../../lib/api";
import { getMediaUrl, getLargestImage, transformContentUrls } from "../../lib/imageUrl";
import StravaEmbed from "../../components/StravaEmbed.astro";

const { slug } = Astro.params;

// extract query params
const previewMode = Astro.url.searchParams.get("status") == "draft";
const [post, siteSettings] = await Promise.all([
    fetchPostBySlug(slug!, previewMode),
    fetchSiteSettings(),
]);

if (!post) {
    return Astro.rewrite("/404");
}

// Transform relative /uploads/ URLs to absolute Strapi URLs
const htmlContent = transformContentUrls(post.richContent);

const image = getLargestImage(post);
const imageUrl = getMediaUrl(image?.url);

// SEO data (fields are nested under post.seo component)
const seoTitle = post.seo?.metaTitle || post.title;
const seoDescription = post.seo?.metaDescription || post.seo?.excerpt || "";
const authorName = post.authorName || `${post.createdBy?.firstname || ""} ${post.createdBy?.lastname || ""}`.trim();
const siteName = siteSettings?.siteName || "Hill People";
---

<Layout
    pageTitle={seoTitle}
    description={seoDescription}
    ogImage={imageUrl}
    ogType="article"
    publishedTime={post.publishedDate}
    authorName={authorName}
    siteName={siteName}
>
    <article class="max-w-3xl mx-auto px-4 py-10">
        {
            imageUrl && (
                <div class="aspect-square overflow-hidden mb-8 rounded-xl">
                    <img
                        src={imageUrl}
                        alt={post.title}
                        class="w-full h-full object-cover"
                    />
                </div>
            )
        }

        <h1 class="text-4xl font-bold mb-4">{post.title}</h1>
        <h2 class="text-2xl font-bold mb-3 mt-12">
            Written by {authorName} on {
                new Date(post.publishedDate).toLocaleDateString()
            }
        </h2>

        <Prose set:html={htmlContent} />

        {
            post.stravaActivityId && (
                <div class="mt-10">
                    <StravaEmbed activityId={post.stravaActivityId} />
                </div>
            )
        }
    </article>
</Layout>
